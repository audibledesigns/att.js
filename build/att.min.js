(function(){function n(){this.callbacks={}}function e(e){var o=this,t=e||{},i=this.config={apiKey:"",user:a.uuid(),jid:"",log:!0,ringTone:"",ringbackTone:"",dependencyBaseUrl:"//js.att.io"},r={onReady:"ready",onUnReady:"unready",onError:"error",onCallBegin:"callBegin",onCallEnd:"callEnd",onOutgoingCall:"outgoingCall",onCalling:"calling"},c={onError:"error",onCallBegin:"callBegin",onCallEnd:"callEnd"},s=function(){return a.isFunc(e.onIncomingCall)?e.onIncomingCall:e.phone&&a.isFunc(e.phone.onIncomingCall)?e.phone.onIncomingCall:function(){}}();return n.call(this),a.extend(this.config,t),this.config.incomingCallHandler=s,delete this.config.onIncomingCall,this.config.phone&&delete this.config.phone.onIncomingCall,this.phone=this,this.on("incomingCall",s),a.each(r,function(n,e){a.isFunc(o.config[n])&&(o.on(e,o.config[n]),o.config[n]=function(n){o.emit(e,n)})}),t.phone&&a.each(c,function(n,e){a.isFunc(o.config.phone[n])&&(o.on(e,o.config.phone[n]),o.config.phone[n]=function(n){o.emit(e,n)})}),this.config.log&&this.on("*",function(n,e){console.log("att.js event:",n,e)}),a.getMe(this.config.apiKey,function(n){n.version=i.version||a.getQueryParam("version")||n.version,i.version=n.version,o.emit("user",n),"a1"===i.version||"a2"===i.version?$.getScript(i.dependencyBaseUrl+"/js/att."+i.version+".js",function(){o.fetchDependencies(i.version)}):$.getScript(i.dependencyBaseUrl+"/js/phono.06.js",function(){i.token=i.apiKey,i.apiKey="7826110523f1241fcfd001859a67128d",i.connectionUrl="http://gw.att.io:8080/http-bind",o.fetchDependencies()})}),o}function o(e,o){var t=this;return this._att=e,this._call=o,this.id=o.id,n.call(this),this.on("*",function(n){t._att.emit(n,t)}),this._call.bind({onRing:function(){t.emit("ring")},onAnswer:function(){t.emit("callBegin")},onHangup:function(){t.emit("callEnd")},onError:function(){t.emit("error")}}),this}var t=this,i={},r={},a=i.util={_uuidCounter:0,uuid:function(){return Math.random().toString(16).substring(2)+(a._uuidCounter++).toString(16)},slice:Array.prototype.slice,isFunc:function(n){return"[object Function]"==Object.prototype.toString.call(n)},extend:function(n){return this.slice.call(arguments,1).forEach(function(e){if(e)for(var o in e)n[o]=e[o]}),n},each:function(n,e){if(n)if(n instanceof Array)n.forEach(e);else for(var o in n)e(o,n[o])},getQueryParam:function(n){var e=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),o="[\\?&]"+e+"=([^&#]*)",t=RegExp(o),i=t.exec(window.location.search);return i?decodeURIComponent(i[1].replace(/\+/g," ")):void 0},h2sSupport:function(){return"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_2) AppleWebKit/536.4 (KHTML, like Gecko) Chrome/19.0.1077.0 Safari/536.4"==window.navigator.userAgent||"Mozilla/5.0 (iPhone; CPU iPhone OS 6_0_1 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Mobile/10A523"==window.navigator.userAgent||window.webkitPeerConnection00&&-1!==window.navigator.userAgent.indexOf("Chrome/24")},getMe:function(n,e){function o(n){return n.split("@")[0]}var t,i="https://auth.tfoundry.com",a={access_token:n};return r.me?e(r.me):(console.log(a),$.ajax({data:a,dataType:"json",url:i+"/me.json",success:function(n){var c=function(){var e;try{e=n.identifiers.external_id[0]}catch(o){}return e}();r.me=n,n.imsNumber=n.ims_phone_number||c,n.imsNumber&&(n.imsNumber=o(n.imsNumber)),n.virtualNumber=n.conference_phone_number,n.ims_phone_number||c?t="a1":n.conference_phone_number&&(t="a3"),$.ajax({data:a,dataType:"json",url:i+"/users/"+n.uid+"/api_services/webrtc.json",success:function(o){var i=o&&o.version;n.version=i?"a"+i:t||"a3",n.number="a3"===n.version?n.virtualNumber||n.phone_number:n.imsNumber||n.phone_number,e(n)}})}}),void 0)}},c={};c.stringify=function(n){var e,o=c.parse(n),t=o.length,i="1"===o.charAt(0),r=o.split("");return t>(i?11:10)?o:!i&&4>t?o:(i&&r.splice(0,1),i?t>1&&(e=4-t,e=e>0?e:0,r.splice(0,0," ("),r.splice(4,0,Array(e+1).join(" ")+") "),t>7&&r.splice(8,0,"-")):t>7?(r.splice(0,0,"("),r.splice(4,0,") "),r.splice(8,0,"-")):t>3&&r.splice(3,0,"-"),(i?"1":"")+r.join(""))},c.parse=function(n){return(n+"").toUpperCase().replace(/[A-Z]/g,function(n){return 0|(n.charCodeAt(0)-65)/3+2-("SVYZ".indexOf(n)>-1)}).replace(/\D/g,"")},c.getCallable=function(n,e){var o=e||"us",t=c.parse(n);return 10!==t.length?"us"==o&&11===t.length&&"1"===t.charAt(0)?t:!1:"us"==o?"1"+t:void 0},i.phoneNumber=c,n.prototype.on=function(n){var e=3===arguments.length,o=e?arguments[1]:void 0,t=e?arguments[2]:arguments[1];return t._groupName=o,(this.callbacks[n]=this.callbacks[n]||[]).push(t),this},n.prototype.once=function(n,e){function o(){t.off(n,o),e.apply(this,arguments)}var t=this;return this.on(n,o),this},n.prototype.releaseGroup=function(n){var e,o,t,i;for(e in this.callbacks)for(i=this.callbacks[e],o=0,t=i.length;t>o;o++)i[o]._groupName===n&&(i.splice(o,1),o--,t--);return this},n.prototype.off=function(n,e){var o,t=this.callbacks[n];return t?1===arguments.length?(delete this.callbacks[n],this):(o=t.indexOf(e),t.splice(o,1),this):this},n.prototype.emit=function(n){var e,o,t=[].slice.call(arguments,1),i=this.callbacks[n],r=this.getWildcardCallbacks(n);if(i)for(e=0,o=i.length;o>e;++e)i[e].apply(this,t);if(r)for(e=0,o=r.length;o>e;++e)r[e].apply(this,[n].concat(t));return this},n.prototype.getWildcardCallbacks=function(n){var e,o,t=[];for(e in this.callbacks)o=e.split("*"),("*"===e||2===o.length&&n.slice(0,o[1].length)===o[1])&&(t=t.concat(this.callbacks[e]));return t},e.prototype=new n,e.prototype.fetchDependencies=function(n){var e=this,o=this.config;"a1"===n?a.h2sSupport()?(console.log("setting up wcgphono"),this.phono=$.wcgphono(a.extend(o,{phone:{onIncomingCall:e._normalizeNonPhonoCallHandlers.bind(e)},onReady:function(){e.emit("ready")}}))):alert("Please use the special Ericsson build of Chromium. It can be downloaded from: http://js.att.io/browsers"):"a2"===n?a.h2sSupport()?(console.log("setting up h2sphono"),this.phono=$.h2sphono(a.extend(o,{phone:{onIncomingCall:e._normalizeNonPhonoCallHandlers.bind(e)},onReady:function(){e.emit("ready")}}))):alert("Please use the special Ericsson build of Chromium. It can be downloaded from: http://js.att.io/browsers"):(console.log("setting up phono"),this.phono=$.phono(a.extend(o,{phone:{onIncomingCall:e._normalizeNonPhonoCallHandlers.bind(e)},onReady:function(){e.sessionId=this.sessionId,a.getMe(o.apiKey,function(n){e.bindNumberToPhonoSession(n.number,e.sessionId,function(){e.emit("ready")})})}})))},e.prototype.bindNumberToPhonoSession=function(n,e,o){$.ajax({url:"http://binder.api.tfoundry.com/session/"+n+"/"+e,type:"POST",success:function(){o()}})},e.prototype.disconnect=function(){this.phono.disconnect(),this.phono=null},e.prototype.connected=function(){return!!this.phono},e.prototype._normalizeNonPhonoCallHandlers=function(n){var e,t,r=n.call;r&&(e=new o(this,r),t=e.initiator||e._call.recipient||"",t=t.replace("tel:","").replace("sip:",""),t=t.split("@")[0],e.call=e,this.emit("incomingCall",e,i.phoneNumber.parse(t)))},e.prototype.dial=function(n,e){var t,r,a=this,c=i.phoneNumber.getCallable(n);return this.emit("calling",n),t="a3"===this.config.version?this.phono.phone.dial("sip:"+c+"@12.208.176.26",{callerId:a.config.myNumber+"@phono06.tfoundry.com"}):this.phono.phone.dial(c,{}),r=new o(this,t),r.bind(e),this.emit("outgoingCall",r),r},o.prototype=new n,o.prototype.bind=function(n){var e=this,o={onRing:"ring",onAnswer:"callBegin",onHangup:"callEnd",onError:"error"},t=n||{};this._att,a.each(o,function(n,o){a.isFunc(t[n])&&e.on(o,t[n])})},o.prototype.answer=function(){return this._call.answer()},o.prototype.hangup=function(){return this._call.hangup()},o.prototype.digit=function(n){return this._call.digit(n)},o.prototype.pushToTalk=function(n){return this._call.pushToTalk(n)},o.prototype.talking=function(n){return this._call.talking(n)},o.prototype.mute=function(n){return this._call.mute(n)},o.prototype.hold=function(n){return this._call.hold(n)},o.prototype.volume=function(n){return this._call.volume(n)},o.prototype.gain=function(n){return this._call.gain(n)},o.prototype.__defineGetter__("initiator",function(){return this._call.initiator}),o.prototype.transferto=function(n){var e=i.phoneNumber.getCallable(n);this._call.transferto(e)},i.Phone=e,t.jQuery&&(t.jQuery.att=function(n){return new e(n)}),"undefined"!=typeof exports?module.exports=i:(t.ATT||(t.ATT={}),a.extend(t.ATT,i))}).call(this);