(function(){function n(){this.callbacks={}}function t(t){var e=this,o=t||{},i=this.config={apiKey:"",user:c.uuid(),jid:"",log:!0,ringTone:"",ringbackTone:"",dependencyBaseUrl:"//js.att.io",msServer:"https://api.foundry.att.com/a1/webrtc",sipDomain:"mon.api.att.net",turnConfig:"STUN:206.18.171.164:5060",mediaType:"audio,video"},r={onReady:"ready",onUser:"user",onUnReady:"unready",onError:"error",onCallBegin:"callBegin",onCallEnd:"callEnd",onOutgoingCall:"outgoingCall",onCalling:"calling"},a={onError:"error",onCallBegin:"callBegin",onCallEnd:"callEnd"},l=function(){return c.isFunc(t.onIncomingCall)?t.onIncomingCall:t.phone&&c.isFunc(t.phone.onIncomingCall)?t.phone.onIncomingCall:function(){}}();return n.call(this),c.extend(this.config,o),this.config.incomingCallHandler=l,delete this.config.onIncomingCall,this.config.phone&&delete this.config.phone.onIncomingCall,this.phone=this,this.on("incomingCall",l),c.each(r,function(n,t){c.isFunc(e.config[n])&&(e.on(t,e.config[n]),e.config[n]=function(n){e.emit(t,n)})}),o.phone&&c.each(a,function(n,t){c.isFunc(e.config.phone[n])&&(e.on(t,e.config.phone[n]),e.config.phone[n]=function(n){e.emit(t,n)})}),this.config.log&&this.on("*",function(n,t){console.log("att.js event:",n,t)}),c.getMe(this.config.apiKey,function(n){n.version=i.version||c.getQueryParam("version")||n.version,i.version=n.version,i.myNumber=n.number,console.log("using API version:",i.version),e.emit("user",n),"a1"===i.version?s.getScript(i.dependencyBaseUrl+"/js/wcg.js",function(){e.initLib(i.version)}):s.getScript(i.dependencyBaseUrl+"/js/phono.06.js",function(){i.token=i.apiKey,i.apiKey="7826110523f1241fcfd001859a67128d",i.connectionUrl="http://gw.att.io:8080/http-bind",e.initLib()})}),e}function e(t,e){var o=this;return this._att=t,this._call=e,this.id=e.id,n.call(this),this.on("*",function(n){o._att.emit(n,o)}),this._call.bind({onRing:function(){o.emit("ring")},onAnswer:function(){o.emit("callBegin")},onHangup:function(){o.emit("callEnd")},onHold:function(){o.emit("hold")},onRetrieve:function(){o.emit("retrieve")},onWaiting:function(){o.emit("waiting")},onError:function(){o.emit("error")}}),this}function o(n,t,e,o){var i=o,r=this;i||(i=n.createCall(t,{audio:!0,video:!0})),e||(e={}),s.extend(this,e),this.state="initial",i.onstatechange=function(n){n.state==Call.State.RINGING&&r.onRing&&(r.onRing(n),r.state="ringing"),n.state==Call.State.ONGOING&&r.onAnswer&&(r.onAnswer(n),r.state="connected"),n.state==Call.State.ENDED&&r.onHangup&&(r.onHangup(n),r.state="disconnected"),n.state==Call.State.ERROR&&r.onError&&(r.onError(n),r.state="disconnected"),n.state==Call.State.HOLDING&&r.onHold&&(r.onHold(n),r.state="holding"),n.state==Call.State.ONGOING&&r.onRetrieve&&(r.onRetrieve(n),r.state="connected"),n.state==Call.State.WAITING&&r.onWaiting&&(r.onWaiting(n),r.state="waiting")},i.onaddstream=function(n){r.onAddStream&&r.onAddStream(n)},this.__defineGetter__("localStreams",function(){return i.localStreams}),this.__defineGetter__("remoteStreams",function(){return i.localStreams}),t||(this.__defineGetter__("from",function(){return i.recipient}),this.__defineGetter__("initiator",function(){return i.recipient})),this.id=c.uuid(),this.call=i,o||i.ring()}var i=this,r={},a={},s=i.jQuery,c=r.util={_uuidCounter:0,uuid:function(){return Math.random().toString(16).substring(2)+(c._uuidCounter++).toString(16)},slice:Array.prototype.slice,isFunc:function(n){return"[object Function]"==Object.prototype.toString.call(n)},extend:function(n){return this.slice.call(arguments,1).forEach(function(t){if(t)for(var e in t)n[e]=t[e]}),n},each:function(n,t){if(n)if(n instanceof Array)n.forEach(t);else for(var e in n)t(e,n[e])},getQueryParam:function(n){var t=n.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),e="[\\?&]"+t+"=([^&#]*)",o=RegExp(e),i=o.exec(window.location.search);return i?decodeURIComponent(i[1].replace(/\+/g," ")):void 0},h2sSupport:function(){return"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_2) AppleWebKit/536.4 (KHTML, like Gecko) Chrome/19.0.1077.0 Safari/536.4"==window.navigator.userAgent||"Mozilla/5.0 (iPhone; CPU iPhone OS 6_0_1 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Mobile/10A523"==window.navigator.userAgent||window.webkitPeerConnection00&&-1!==window.navigator.userAgent.indexOf("Chrome/24")},getMe:function(n,t){var e="https://auth.tfoundry.com",o={access_token:n};return a.me?t(a.me):(console.log(o),s.ajax({data:o,dataType:"json",url:e+"/me.json",success:function(n){a.me=n,s.ajax({data:o,dataType:"json",url:e+"/users/"+n.uid+"/api_services/webrtc.json",success:function(e){var o=e&&e.version,i=e&&e.options&&e.options.phone_number;n.version=o?"a"+o:"a1",n.number=i||n.phone_number,t(n)}})}}),void 0)}},l={};l.stringify=function(n){var t,e=l.parse(n),o=e.length,i="1"===e.charAt(0),r=e.split("");return o>(i?11:10)?e:!i&&4>o?e:(i&&r.splice(0,1),i?o>1&&(t=4-o,t=t>0?t:0,r.splice(0,0," ("),r.splice(4,0,Array(t+1).join(" ")+") "),o>7&&r.splice(8,0,"-")):o>7?(r.splice(0,0,"("),r.splice(4,0,") "),r.splice(8,0,"-")):o>3&&r.splice(3,0,"-"),(i?"1":"")+r.join(""))},l.parse=function(n){return(n+"").toUpperCase().replace(/[A-Z]/g,function(n){return 0|(n.charCodeAt(0)-65)/3+2-("SVYZ".indexOf(n)>-1)}).replace(/\D/g,"")},l.getCallable=function(n,t){var e=t||"us",o=l.parse(n);return 10!==o.length?"us"==e&&11===o.length&&"1"===o.charAt(0)?o:!1:"us"==e?"1"+o:void 0},r.phoneNumber=l,s&&(s.phoneNumber=l),n.prototype.on=function(n){var t=3===arguments.length,e=t?arguments[1]:void 0,o=t?arguments[2]:arguments[1];return o._groupName=e,(this.callbacks[n]=this.callbacks[n]||[]).push(o),this},n.prototype.once=function(n,t){function e(){o.off(n,e),t.apply(this,arguments)}var o=this;return this.on(n,e),this},n.prototype.releaseGroup=function(n){var t,e,o,i;for(t in this.callbacks)for(i=this.callbacks[t],e=0,o=i.length;o>e;e++)i[e]._groupName===n&&(i.splice(e,1),e--,o--);return this},n.prototype.off=function(n,t){var e,o=this.callbacks[n];return o?1===arguments.length?(delete this.callbacks[n],this):(e=o.indexOf(t),o.splice(e,1),this):this},n.prototype.emit=function(n){var t,e,o=[].slice.call(arguments,1),i=this.callbacks[n],r=this.getWildcardCallbacks(n);if(i)for(t=0,e=i.length;e>t;++t)i[t].apply(this,o);if(r)for(t=0,e=r.length;e>t;++t)r[t].apply(this,[n].concat(o));return this},n.prototype.getWildcardCallbacks=function(n){var t,e,o=[];for(t in this.callbacks)e=t.split("*"),("*"===t||2===e.length&&n.slice(0,e[1].length)===e[1])&&(o=o.concat(this.callbacks[t]));return o},t.prototype=Object.create(n.prototype,{constructor:{value:t}}),t.prototype.initLib=function(n){var t=this,e=this.config,o=e.apiKey.indexOf(false)?"oauth "+e.apiKey:e.apiKey;"a1"===n?(console.log("setting up wcg"),this.ms=new MediaServices(e.msServer,e.user,o,e.mediaType),this.ms.onclose=function(n){t.emit("unready",n)},this.ms.onerror=function(n){t.emit("error",n)},this.ms.oninvite=t._normalizeNonPhonoCallHandlers.bind(t),this.ms.onready=function(){t.emit("ready")}):(console.log("setting up phono"),this.phono=s.phono(c.extend(e,{phone:{onIncomingCall:t._normalizeNonPhonoCallHandlers.bind(t),ringTone:"",ringbackTone:""},onReady:function(){t.sessionId=this.sessionId,c.getMe(e.apiKey,function(n){t.bindNumberToPhonoSession(n.number,t.sessionId,function(){t.emit("ready")})})}})))},t.prototype.bindNumberToPhonoSession=function(n,t,e){s.ajax({url:"http://binder.api.tfoundry.com/session/"+n+"/"+t,type:"POST",success:function(){e()}})},t.prototype.disconnect=function(){this.phono.disconnect(),this.phono=null},t.prototype.connected=function(){return!!this.phono},t.prototype._normalizeNonPhonoCallHandlers=function(n){var t,o,i=n.call;i&&(t=new e(this,i),o=t.initiator||t._call.recipient||"",o=o.replace("tel:","").replace("sip:",""),o=o.split("@")[0],t.call=t,this.emit("incomingCall",t,r.phoneNumber.parse(o)))},t.prototype.dial=function(n,t){var i,a,s=this,c=r.phoneNumber.getCallable(n);return this.emit("calling",n),i="a3"===this.config.version?this.phono.phone.dial("sip:"+c+"@12.208.176.26",{callerId:s.config.myNumber+"@phono06.tfoundry.com"}):new o(this.ms,"sip:"+c+"@"+this.config.sipdomain),a=new e(this,i),a.bind(t),a.emit("ring"),this.emit("outgoingCall",a),a},e.prototype=Object.create(n.prototype,{constructor:{value:e}}),e.prototype.bind=function(n){var t=this,e={onRing:"ring",onAnswer:"callBegin",onHangup:"callEnd",onHold:"hold",onRetrieve:"retrieve",onWaiting:"waiting",onError:"error"},o=n||{};this._att,c.each(e,function(n,e){c.isFunc(o[n])&&t.on(e,o[n])})},e.prototype.answer=function(){return this._call.answer()},e.prototype.hangup=function(){return this._call.hangup()},e.prototype.digit=function(n){return this._call.digit(n)},e.prototype.pushToTalk=function(n){return this._call.pushToTalk(n)},e.prototype.talking=function(n){return this._call.talking(n)},e.prototype.mute=function(n){return this._call.mute(n)},e.prototype.hold=function(n){return this._call.hold(n)},e.prototype.volume=function(n){return this._call.volume(n)},e.prototype.gain=function(n){return this._call.gain(n)},e.prototype.__defineGetter__("initiator",function(){return this._call.initiator}),e.prototype.transferto=function(n){var t=r.phoneNumber.getCallable(n);this._call.transferto(t)},o.prototype.answer=function(){this.call.answer()},o.prototype.hangup=function(){this.call.end()},o.prototype.digit=function(){},o.prototype.pushToTalk=function(){},o.prototype.talking=function(){},o.prototype.mute=function(){},o.prototype.hold=function(n){n?this.call.hold():this.call.resume()},o.prototype.volume=function(){},o.prototype.gain=function(){},o.prototype.bind=function(n){var t;if(n)for(t in n)"function"==typeof n[t]&&(this[t]=n[t])},o.prototype.transferto=function(n){var t="sip:"+n+"@"+sipdomain;this.call.transferto(t)},r.Phone=t,s&&(s.att=function(n){return new t(n)}),"undefined"!=typeof exports?module.exports=r:(i.ATT||(i.ATT={}),c.extend(i.ATT,r))}).call(this);